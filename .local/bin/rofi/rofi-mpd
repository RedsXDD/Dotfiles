#!/usr/bin/env sh

killall rofi >/dev/null 2>&1

# Import current theme:
theme="${XDG_CONFIG_HOME:-$HOME/.config}/rofi/themes/applets/type-4/style-2.rasi"

# Set default appearence:
list_col="$(grep 'list_col' "$theme" | cut -d'=' -f2)"
list_row="$(grep 'list_row' "$theme" | cut -d'=' -f2)"

# Theme Elements:
status="$(mpc status)"
if [ -z "$status" ]; then
	prompt='Offline'
	mesg='MPD is Offline'
else
	prompt="$(mpc -f '%artist%' current)"
	mesg="$(mpc -f '%title%' current) :: $(mpc status | awk '/#/ {print $3}')"
	[ -z "$prompt" ] && prompt='Stopped'
fi

# Options
if [ "$(grep 'USE_ICON' "$theme" | cut -d'=' -f2)" = 'NO' ]; then
	case "$status" in
		*'[playing]'*) opt_1='󰏤 Pause' ;;
		*'[paused]'*)  opt_1='󰐊 Play' ;;
		*) opt_1='󰐊 Play' ;;
	esac
	opt_2='󰓛 Stop'
	opt_3='󰒮 Previous'
	opt_4='󰒭 Next'
	opt_5=' Repeat'
	opt_6='󰒝 Random'
else
	case "$status" in
		*'[playing]'*) opt_1='󰏤' ;;
		*'[paused]'*)  opt_1='󰐊' ;;
		*) opt_1='󰐊' ;;
	esac
	opt_2='󰓛'
	opt_3='󰒮'
	opt_4='󰒭'
	opt_5=''
	opt_6='󰒝'
fi

# Repeat:
case "$status" in
	*'single: on'*)  [ -n "$active" ] && active="$active,4" || active='-a 4' ;;
	*'single: off'*) [ -n "$urgent" ] && urgent="$urgent,4" || urgent='-u 4' ;;
	*) opt_5='󱈸 Parsing Error' ;;
esac

# Random:
case "$status" in
	*'random: on'*)  [ -n "$active" ] && active="$active,5" || active='-a 5' ;;
	*'random: off'*) [ -n "$urgent" ] && urgent="$urgent,5" || urgent='-u 5' ;;
	*) opt_6='󱈸 Parsing Error' ;;
esac

# Pass variables to rofi dmenu
run_rofi(){
	[ "$(awk '/fullscreen:/ {print $2}' "$theme")" != 'true;' ] && border_setup='window { border: 2px solid; border-color: @border-colour; }'

	# shellcheck disable=SC2086
	printf '%s\n' "$opt_1" "$opt_2" "$opt_3" "$opt_4" "$opt_5" "$opt_6" |
		rofi -i -dmenu \
			-theme-str "$border_setup
					listview { columns: $list_col; lines: $list_row; }
					prompt { text-color: @background; }
					button selected         { text-color: @background; }
					element normal.urgent   { text-color: @background; }
					element normal.active   { text-color: @background; }
					element selected.normal { text-color: @background; }
					element selected.urgent { text-color: @background; }
					element selected.active { text-color: @background; }
					textbox-prompt-colon {
						str: \"󰝚\";
						padding: 10px 19px 10px 13px;
						text-color: @background;
					}" \
			-p "$prompt" \
			-mesg "$mesg" \
			${active} ${urgent} \
			-markup-rows \
			-theme "$theme"
}

# Actions
case "$(run_rofi)" in
	"$opt_1") mpc -q toggle && notify-send -u low -t 2000 "󰝚  $(mpc current)" ;;
	"$opt_2") mpc -q stop   && notify-send -u low -t 2000 '󰝚  Stopped Music' ;;
	"$opt_3") mpc -q prev   && notify-send -u low -t 2000 "󰝚  $(mpc current)" ;;
	"$opt_4") mpc -q next   && notify-send -u low -t 2000 "󰝚  $(mpc current)" ;;
	"$opt_5") mpc -q single && notify-send -u low -t 2000 '󰝚  Single mode toggled' ;;
    	"$opt_6") mpc -q random && notify-send -u low -t 2000 '󰝚  Random mode toggled' ;;
	*) exit 1 ;;
esac
