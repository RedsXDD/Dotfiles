#!/usr/bin/env sh

# shellcheck disable=1091,2034,2154
# Pywal delimiter texts.
pywal_gen_text='The following lines were auto generated by pywal_postrun script:'
pywal_eof_text='EOF_PYWAL'

# Global variables:
oomox_theme_name='oomox-pywal'
oomox_plugins_dir='/opt/oomox/plugins'
pywal_cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/wal"
pywal_oomox_file="${pywal_cache_dir}/colors-oomox"
send_notification(){ notify-send -t 3000 'Pywal_postrun' "$1"; }

[ -f "$pywal_cache_dir/colors.sh" ] && . "$pywal_cache_dir/colors.sh"

#: Restart processes function {{{
restart_processes(){
	killall waybar cava swaync
	while pgrep -x waybar >/dev/null; do sleep 1; done
	while pgrep -x cava >/dev/null; do sleep 1; done
	while pgrep -x swaync >/dev/null; do sleep 1; done
	waybar >/dev/null &
	swaync >/dev/null &
}
#: }}}
#: Gnuplot theme {{{
gen_gnuplot_theme(){
	[ ! -f "$pywal_cache_dir/colors.sh" ] && return 1

	gen_gnuplot_config_theme(){
		cat <<- GNUPLOTEOF
		# $pywal_gen_text

		# Basic configs:
		set isosamples 50
		set hidden3d

		# Key, border & grid colors:
		set grid xtics ytics linetype 1 linewidth 1 linecolor rgb '$foreground'
		set border linewidth 3 linecolor rgb '$color4'
		set key textcolor rgb '$foreground'

		# Labels:
		set xlabel "X axis" textcolor rgb '$foreground'
		set ylabel "Y axis" textcolor rgb '$foreground'
		set zlabel "Z axis" textcolor rgb '$foreground'

		# Set background color:
		set terminal GNUTERM background rgb '$background'
		set object rectangle from screen 0,0 to screen 1,1 behind fillcolor rgb '$background' fillstyle solid noborder

		# Color some lines:
		set linetype 1 linewidth 2 pointtype 6 linecolor rgb '$color5'
		set linetype 2 linewidth 2 pointtype 6 linecolor rgb '$color7'
		set linetype 3 linewidth 2 pointtype 6 linecolor rgb '$color4'
		set linetype 4 linewidth 2 pointtype 6 linecolor rgb '$color6'
		set linetype 5 linewidth 2 pointtype 6 linecolor rgb '$color2'
		set linetype 6 linewidth 2 pointtype 6 linecolor rgb '$color3'
		set linetype 7 linewidth 2 pointtype 6 linecolor rgb '$color1'

		# $pywal_eof_text
		GNUPLOTEOF
	}

	gnuplot_config_dir="${XDG_CONFIG_HOME:-$HOME/.config}/gnuplot"
	[ ! -d "$gnuplot_config_dir" ] && mkdir -vp "$gnuplot_config_dir"

	tmp_gnuplot="$(mktemp)"
	[ -f "${gnuplot_config_dir}/gnuplotrc" ] && sed "/$pywal_gen_text/,/$pywal_eof_text/d" "${gnuplot_config_dir}/gnuplotrc" > "$tmp_gnuplot"
	gen_gnuplot_config_theme >> "$tmp_gnuplot"
	mv -vf "$tmp_gnuplot" "${gnuplot_config_dir}/gnuplotrc"
}
#: }}}
#: Btop theme {{{
gen_btop_theme(){
	[ ! -f "$pywal_cache_dir/colors.sh" ] && return 1

	gen_btop_config_theme(){
		cat <<- BTOPEOF
		# $pywal_gen_text

		# Main background, empty for terminal default, need to be empty if you want transparent background
		theme[main_bg]="$background"

		# Main text color
		theme[main_fg]="$foreground"

		# Title color for boxes
		theme[title]="$foreground"

		# Highlight color for keyboard shortcuts
		theme[hi_fg]="$color8"

		# Background color of selected item in processes box
		theme[selected_bg]="$color5"

		# Foreground color of selected item in processes box
		theme[selected_fg]="$foreground"

		# Color of inactive/disabled text
		theme[inactive_fg]="$color8"

		# Color of text appearing on top of graphs, i.e uptime and current network graph scaling
		theme[graph_text]="$foreground"

		# Background color of the percentage meters
		theme[meter_bg]="$color8"

		# Misc colors for processes box including mini cpu graphs, details memory graph and details status text
		theme[proc_misc]="$color4"

		# Cpu box outline color
		theme[cpu_box]="$color4"

		# Memory/disks box outline color
		theme[mem_box]="$color2"

		# Net up/down box outline color
		theme[net_box]="$color1"

		# Processes box outline color
		theme[proc_box]="$color6"

		# Box divider line and small boxes line color
		theme[div_line]="$color8"

		# Temperature graph colors
		theme[temp_start]="$color4"
		theme[temp_mid]="$color5"
		theme[temp_end]="$color5"

		# CPU graph colors
		theme[cpu_start]="$color4"
		theme[cpu_mid]="$color6"
		theme[cpu_end]="$color2"

		# Mem/Disk free meter
		theme[free_start]="$color13"
		theme[free_mid]="$color5"
		theme[free_end]="$color5"

		# Mem/Disk cached meter
		theme[cached_start]="$color14"
		theme[cached_mid]="$color6"
		theme[cached_end]="$color6"

		# Mem/Disk available meter
		theme[available_start]="$color11"
		theme[available_mid]="$color3"
		theme[available_end]="$color3"

		# Mem/Disk used meter
		theme[used_start]="$color10"
		theme[used_mid]="$color2"
		theme[used_end]="$color2"

		# Download graph colors
		theme[download_start]="$color4"
		theme[download_mid]="$color2"
		theme[download_end]="$color6"

		# Upload graph colors
		theme[upload_start]="$color4"
		theme[upload_mid]="$color5"
		theme[upload_end]="$color5"

		# Process box color gradient for threads, mem and cpu usage
		theme[process_start]="$color2"
		theme[process_mid]="$color10"
		theme[process_end]="$color8"

		# $pywal_eof_text
		BTOPEOF
	}

	btop_theme_dir="${XDG_CONFIG_HOME:-$HOME/.config}/btop/themes"
	[ ! -d "$btop_theme_dir" ] && mkdir -vp "$btop_theme_dir"

	tmp_btop="$(mktemp)"
	[ -f "${btop_theme_dir}/pywal.theme" ] && sed "/$pywal_gen_text/,/$pywal_eof_text/d" "${btop_theme_dir}/pywal.theme" > "$tmp_btop"
	gen_btop_config_theme >> "$tmp_btop"
	mv -vf "$tmp_btop" "${btop_theme_dir}/pywal.theme"
}
#: }}}
#: IMV theme {{{
gen_imv_theme(){
	[ ! -f "$pywal_cache_dir/colors.sh" ] && return 1

	imv_config_dir="${XDG_CONFIG_HOME:-$HOME/.config}/imv"
	[ ! -d "$imv_config_dir" ] && mkdir -vp "$imv_config_dir"

	tmp_imv="$(mktemp)"
	[ -f "${imv_config_dir}/config" ] && sed "s|background =.*|background = ${background###}|g; s|overlay_background_color =.*|overlay_background_color = ${color4###}|g" "${imv_config_dir}/config" > "$tmp_imv"
	mv -vf "$tmp_imv" "${imv_config_dir}/config"
}
#: }}}
#: Mpv theme {{{
gen_mpv_theme(){
	[ ! -f "$pywal_cache_dir/colors.sh" ] && return 1

	gen_mpv_config_theme(){
		cat <<- MPVEOF
		# $pywal_gen_text

		background-color='$background'
		osd-back-color='$color8'
		osd-border-color='$background'
		osd-color='$foreground'
		osd-shadow-color='$background'

		# $pywal_eof_text
		MPVEOF
	}

	gen_mpv_stats(){
		cat <<- MPV_STATS_EOF
		# $pywal_gen_text

		# NOTE: Colors are in #BBGGRR format
		border_color=$background
		font_color=$foreground
		plot_bg_border_color=$color11
		plot_bg_color=$background
		plot_color=$color11

		# $pywal_eof_text
		MPV_STATS_EOF
	}

	mpv_config_dir="${XDG_CONFIG_HOME:-$HOME/.config}/mpv"
	mpv_script_opts_dir="${XDG_CONFIG_HOME:-$HOME/.config}/mpv/script-opts"
	[ ! -d "$mpv_script_opts_dir" ] && mkdir -vp "$mpv_script_opts_dir"

	# Generate mpv.conf theme.
	tmp_mpv="$(mktemp)"
	[ -f "${mpv_config_dir}/mpv.conf" ] && sed "/$pywal_gen_text/,/$pywal_eof_text/d" "${mpv_config_dir}/mpv.conf" > "$tmp_mpv"
	gen_mpv_config_theme >> "$tmp_mpv"
	mv -vf "$tmp_mpv" "${mpv_config_dir}/mpv.conf"

	# This creates the stats.conf theme under "$tmp_mpv_stats", and the awk command converts the colors to BBGGRR format.
	tmp_mpv_stats="$(mktemp)"
	trap 'rm -rf "$tmp_mpv_stats"' 0 1 15

	[ -f "${mpv_script_opts_dir}/stats.conf" ] && sed "/$pywal_gen_text/,/$pywal_eof_text/d" "${mpv_script_opts_dir}/stats.conf" > "$tmp_mpv_stats"
	gen_mpv_stats >> "$tmp_mpv_stats"
	awk 'BEGIN {FS= OFS= "="} $2 ~ /^#[A-Fa-f0-9]{6}$/ {
		a=substr($2,2,2);
		b=substr($2,4,2);
		c=substr($2,6,2);
		$2 = c b a
	} 1' "$tmp_mpv_stats" > "$mpv_script_opts_dir/stats.conf"
}
#: }}}
#: Fix dolphin background color {{{
gen_dolphin_fix(){
	[ ! -f "$pywal_cache_dir/colors.sh" ] && return 1

	gen_dolphin_config_theme(){
		cat <<- DOLPHINEOF
		# $pywal_gen_text

		[Colors:View]
		BackgroundNormal=$background

		# $pywal_eof_text
		DOLPHINEOF
	}

	tmp_kdeblobals="$(mktemp)"

	kdeglobals_file="${XDG_CONFIG_HOME:-$HOME/.config}/kdeglobals"
	[ -f "$kdeglobals_file" ] && sed "/$pywal_gen_text/,/$pywal_eof_text/d" "$kdeglobals_file" > "$tmp_kdeglobals"
	gen_dolphin_config_theme >> "$tmp_kdeblobals"
	mv -vf "$tmp_kdeblobals" "$kdeglobals_file"
}
#: }}}
#: Oomox theming {{{
# Auto generate themix/oomox theme:
gen_oomox_theme(){
	[ ! -f "$pywal_oomox_file" ] && return 1

	send_notification 'Generating Oomox colorscheme ...'

	oomox_colors_dir="${XDG_CONFIG_HOME:-$HOME/.config}/oomox/colors"
	[ ! -d "$oomox_colors_dir" ] && mkdir -vp "$oomox_colors_dir"
	cp -vf "$pywal_oomox_file" "${oomox_colors_dir}/pywal"

	# NOTE: gtk2 applications do not read themes under .local/share/themes, so the target dir has to be ~/.themes
	oomox-cli --hidpi false \
		--make-opts all \
		--target-dir "${HOME}/.themes" \
		--output "$oomox_theme_name" \
		"$pywal_oomox_file"

	gtk4_output_dir="${HOME}/.themes/${oomox_theme_name}/gtk-4.0"
	[ ! -d "$gtk4_output_dir" ] && mkdir -vp "$gtk4_output_dir"

	themix-base16-cli "${oomox_plugins_dir}/base16/templates/gtk4/templates/gtk.mustache" "${pywal_cache_dir}/colors-oomox" | sed '/^ERROR:/d; /^Import/d' > "${gtk4_output_dir}/gtk.css"

	send_notification 'âœ… Oomox colorscheme generated successfully!'
}

# Auto generate oomox qt5/qt6 themes:
gen_oomox_qt_theme(){
	qt_output_dir="${XDG_CONFIG_HOME:-$HOME/.config}/oomox-qtstyleplugin/themes"
	qt_plugin_file="$oomox_plugins_dir/base16/templates/qt-oomox-styleplugin/templates/default.mustache"

	[ ! -d "$qt_output_dir" ] && mkdir -vp "$qt_output_dir"
	[ -f "$qt_plugin_file" ] && themix-base16-cli "$qt_plugin_file" "$pywal_oomox_file" | sed '/^ERROR:/d; /^Import/d' > "${qt_output_dir}/${oomox_theme_name}.css"
}

# Auto generate oomox icon theme:

gen_oomox_icon_theme(){
	[ ! -f "$pywal_oomox_file" ] && return 1

	# Main variables:
	icon_theme_name="$1"
	output_name="oomox_pywal_${icon_theme_name}"
	destination_dir="${XDG_DATA_HOME:-$HOME/.local/share}/icons/oomox_pywal_${icon_theme_name}"

	send_notification "Generating Oomox icon theme '$(echo "$icon_theme_name" | sed 's/_/ /g')' ..."
	case "$icon_theme_name" in
		'archdroid') oomox-archdroid-icons-cli -d "$destination_dir" -o "$output_name" "$pywal_oomox_file" || return 1 ;;
		'gnome_colors') oomox-gnome-colors-icons-cli -d "$destination_dir" -o "$output_name" "$pywal_oomox_file" || return 1 ;;
		*)
			oomox_plugin_path="${oomox_plugins_dir}/icons_${icon_theme_name}/change_color.sh"
			"$oomox_plugin_path" \
				-d "$destination_dir" \
				-o "$output_name" \
				"$pywal_oomox_file" || return 1
		;;
	esac

	send_notification "âœ… Oomox icon theme '$(echo "$icon_theme_name" | sed 's/_/ /g')' generateted successfully!"
}
#: }}}
#: Kvantum theming {{{
gen_kvantum_theme(){
	kvantum_theme_name='Pywal16-pywal'
	Kvantum_theme_dir="${XDG_CONFIG_HOME:-$HOME/.config}/Kvantum/${kvantum_theme_name}"
	[ ! -d "$Kvantum_theme_dir" ] && mkdir -vp "$Kvantum_theme_dir"

	# Check if require theme files exist under `$pywal_cache_dir`.
	[ ! -f "${pywal_cache_dir}/${kvantum_theme_name}.kvconfig" ] && return 1
	[ ! -f "${pywal_cache_dir}/${kvantum_theme_name}.svg" ] && return 1

	cp -vf "${pywal_cache_dir}/${kvantum_theme_name}.kvconfig" "$Kvantum_theme_dir"
	cp -vf "${pywal_cache_dir}/${kvantum_theme_name}.svg" "$Kvantum_theme_dir"
	kvantummanager --set "$kvantum_theme_name"
}
#: }}}
#: Main function {{{
main(){
	# Auto reload tmux theming:
	[ -n "$TMUX" ] && tmux source-file ~/.config/tmux/tmux.conf

	# Restart main programs:
	restart_processes

	# Generate main program themes:
	gen_gnuplot_theme
	gen_btop_theme
	gen_imv_theme
	gen_mpv_theme
	gen_dolphin_fix

	# Oomux theme:
	gen_kvantum_theme &
	gen_oomox_theme &
	gen_oomox_qt_theme &
	gen_oomox_icon_theme 'archdroid' &
	gen_oomox_icon_theme 'gnome_colors' &
	gen_oomox_icon_theme 'papirus' &
	gen_oomox_icon_theme 'numix' &
	gen_oomox_icon_theme 'suruplus_aspromauros' &
}
main
#: }}}

# vim:fileencoding=utf-8:foldmethod=marker
