#!/usr/bin/env sh

# Auto reload tmux theming:
[ -n "$TMUX" ] && tmux source-file ~/.config/tmux/tmux.conf

# Oomox setup:
oomox_theme_name='oomox-pywal'
oomox_plugins_dir='/opt/oomox/plugins'
pywal_cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/wal"
pywal_oomox_file="${pywal_cache_dir}/colors-oomox"
cp -f "$pywal_oomox_file" "${XDG_CONFIG_HOME:-$HOME/.config}"/oomox/colors/pywal

send_notification(){
	notify-send -t 3000 'Pywal_postrun' "$1"
}

restart_processes(){
	killall waybar cava swaync
	while pgrep -x waybar >/dev/null; do sleep 1; done
	while pgrep -x cava >/dev/null; do sleep 1; done
	while pgrep -x swaync >/dev/null; do sleep 1; done
	waybar >/dev/null &
	swaync >/dev/null &
}

# Auto generate themix/oomox theme:
gen_oomox_theme(){
	send_notification 'Generating Oomox colorschemes ...'
	if [ -f "$pywal_oomox_file" ]; then
		oomox-cli --hidpi true \
			--make-opts all \
			--target-dir "${XDG_DATA_HOME:-$HOME/.local/share}"/themes \
			--output "$oomox_theme_name" \
			"$pywal_oomox_file" &&
		send_notification '✅ Colorscheme generation completed successfully!'
	fi
}

# Auto generate oomox qt5/qt6 themes:
gen_oomox_qt_theme(){
	qt_output_dir="${XDG_CONFIG_HOME:-$HOME/.config}/oomox-qtstyleplugin/themes"
	[ ! -d "$qt_output_dir" ] && mkdir -p "$qt_output_dir"

	qt_plugin_file="$oomox_plugins_dir/base16/templates/qt-oomox-styleplugin/templates/default.mustache"
	[ -f "$qt_plugin_file" ] && themix-base16-cli "$qt_plugin_file" "$pywal_oomox_file" | sed '/^ERROR:/d; /^Import/d' > "${qt_output_dir}/${oomox_theme_name}.css"
}

# Auto generate oomox icon theme:
gen_oomox_icon_theme(){
	icon_theme_name="$1"
	oomox_plugin_path="$oomox_plugins_dir/icons_${icon_theme_name}"
	destination_name="oomox_pywal_${icon_theme_name}"

	send_notification "Generating Oomox icon theme '$(echo "$icon_theme_name" | sed 's/_/ /g')' ..."
	if [ -f "$pywal_oomox_file" ]; then
		"$oomox_plugin_path"/change_color.sh \
			-d "${XDG_DATA_HOME:-$HOME/.local/share}"/icons/"$destination_name" \
			-o "$destination_name" \
			"$pywal_oomox_file" &&
			send_notification "✅ Oomox icon theme '$(echo "$icon_theme_name" | sed 's/_/ /g')' generateted successfully!"
	fi
}

main(){
	restart_processes
	gen_oomox_theme &
	gen_oomox_qt_theme &
	gen_oomox_icon_theme 'papirus' &
	gen_oomox_icon_theme 'numix' &
	gen_oomox_icon_theme 'suruplus_aspromauros' &
}

main
